<div class="tree" [ngClass]="{
  'selected': source.selected,
  'highlight': source.expanded || source.opened,
  'no-highlight': !source.expanded && !source.opened
}">
  <mat-icon
    *ngIf="source.expandable && source.expanded"
    [id]="'raven-tree-'+source.name+'-collapse'"
    (click)="collapse.emit(source)">
    remove
  </mat-icon>
  <mat-icon
    *ngIf="source.expandable && !source.expanded"
    [id]="'raven-tree-'+source.name+'-expand'"
    (click)="expand.emit(source)">
    add
  </mat-icon>

  <mat-icon
    *ngIf="source.openable && source.opened"
    [id]="'raven-tree-'+source.name+'-close'"
    (click)="close.emit(source)">
    radio_button_checked
  </mat-icon>
  <mat-icon
    *ngIf="source.openable && !source.opened"
    [id]="'raven-tree-'+source.name+'-open'"
    (click)="open.emit(source)">
    radio_button_unchecked
  </mat-icon>

  <span (click)="select.emit(source)" class="name">
    <i [ngClass]="source.icon" aria-hidden="true"></i> {{source.name}}
  </span>

  <button
    *ngIf="source.selected"
    class="menu-icon"
    mat-icon-button
    [matMenuTriggerFor]="actionsMenu">
    <mat-icon>more_vert</mat-icon>
  </button>

  <mat-menu
    #actionsMenu="matMenu"
    [overlapTrigger]="false"
    y-position="below">
    <ng-container *ngFor="let a of source.actions">
      <ng-container *ngIf="a.name === 'Apply'">
        <button mat-menu-item [matMenuTriggerFor]="applyMenu">{{a.name}}</button>
      </ng-container>
      <ng-container *ngIf="a.name === 'File metadata'">
        <button mat-menu-item (click)="openMetadata.emit(tree[id])">File Metadata</button>
      </ng-container>
      <ng-container *ngIf="a.name !== 'Apply' && a.name !== 'File metadata'">
        <button mat-menu-item (click)="action.emit({ event: a.event, source: source })">{{a.name}}</button>
      </ng-container>
    </ng-container>
  </mat-menu>

  <mat-menu
    #applyMenu="matMenu"
    [overlapTrigger]="false"
    y-position="below">
    <button mat-menu-item (click)="action.emit({ event: 'apply-layout', source: source })">Layout</button>
    <button mat-menu-item (click)="action.emit({ event: 'apply-state', source: source })">State</button>
  </mat-menu>
</div>

<ul *ngIf="source.expanded">
  <li *ngFor="let childId of source.childIds; trackBy: trackByFn">
    <raven-tree
      [class]="tree[childId].name"
      [id]="childId"
      [source]="tree[childId]"
      [tree]="tree"
      (action)="action.emit($event)"
      (close)="close.emit($event)"
      (collapse)="collapse.emit($event)"
      (expand)="expand.emit($event)"
      (open)="open.emit($event)"
      (openMetadata)="openMetadata.emit($event)"
      (select)="select.emit($event)">
    </raven-tree>
  </li>
</ul>
